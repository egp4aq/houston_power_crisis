---
title: "Homework 3"
format: html
author: Liz Peterson
date: 10-23-2024
editor_options: 
  chunk_output_type: console
---

## Load libraries
```{r}
library(tidyverse)
library(here)
library(sf)
library(terra)
library(tmap)
library(spData)
library(spDataLarge)
library(stars)
```

## Read in data
```{r}
# Read in roads data
roads <- st_read(here('data','gis_osm_roads_free_1.gpkg'))

# Read in houses data
houses <- st_read(here('data','gis_osm_buildings_a_free_1.gpkg'))

# Read in socioeconomic data
texas <- st_read(here('data','ACS_2019_5YR_TRACT_48_TEXAS.gdb'), layer = 'ACS_2019_5YR_TRACT_48_TEXAS')
income <- st_read(here('data','ACS_2019_5YR_TRACT_48_TEXAS.gdb'), layer = "X19_INCOME")

# Check class of these terms to make sure they are correct
class(texas)
class(income)
                 
# Read in lights data
seven_05_tile <- read_stars(here("data/VNP46A1/VNP46A1.A2021038.h08v05.001.2021039064328.tif")) 
seven_06_tile <- read_stars(here("data/VNP46A1/VNP46A1.A2021038.h08v06.001.2021039064329.tif"))
sixteen_05_tile <- read_stars(here("data/VNP46A1/VNP46A1.A2021047.h08v05.001.2021048091106.tif"))
sixteen_06_tile <- read_stars(here("data/VNP46A1/VNP46A1.A2021047.h08v06.001.2021048091105.tif"))
```

```{r}
# Merge the two tiles for the same date to create a workable raster
tile_07 <- st_mosaic(seven_05_tile, seven_06_tile)
tile_16 <- st_mosaic(sixteen_05_tile, sixteen_06_tile)
```

```{r}
# Check CRS for what we've read in
print(st_crs(houses) == st_crs(texas))
print(st_crs(tile_07) == st_crs(texas))
print(st_crs(tile_16) == st_crs(texas))
print(st_crs(tile_07) == st_crs(tile_16))
```

```{r}
# Because the two tile rasters have the same CRS, we will use those as the refernce, and update houses and texas to have that same CRS
houses <- st_transform(houses, st_crs(tile_07))
texas <- st_transform(texas, st_crs(tile_07))
```

```{r}
# Run another check to make sure all CRS are now equal
# Create a list of all the rasters, and then create a for loop to make sure they all have the same crs, using the CRS of houses as a reference
rast_list <- list(houses,texas,tile_07,tile_16)
reference <- crs(rast_list[[1]])
for (i in 2:length(rast_list)) {
  print(crs(rast_list[[i]])==reference)
}
```

```{r}
# Find the change in night lights intensity (presumably) caused by the storm
# Create a difference raster of the difference in intensity of those two nights
diff_rast <- rast(tile_07) - rast(tile_16)
diff_rast[diff_rast < 200] <- NA
```

```{r}
# Vectorize the blackout mask (reclassified difference raster)
blackout_mask <- diff_rast %>%
  st_as_sf(as_points = FALSE, merge = TRUE) %>%
  st_make_valid()
```

```{r}
# Initial map of blackout mask to make sure reclassification worked
tm_shape(blackout_mask) +
  tm_polygons()
```

```{r}
# Crop blackout mask to Houston area
# Create a matrix of our coordinates
bounding_box <- st_bbox(c(xmin = -96.5, xmax = -95.4, ymin = 29, ymax = 30.5),
                        crs = st_crs(blackout_mask)) %>%
  st_as_sfc()

blackout_mask <- st_transform(blackout_mask, crs = 3083)
bounding_box <- st_transform(bounding_box, crs = 3083)

# # Convert coordinates to an sf polygon
# bounding_box <- st_as_sfc(coords)

# Crop the raster
blackout_cropped <- st_intersection(blackout_mask, bounding_box)
```

```{r}
tm_shape(blackout_cropped) +
  tm_polygons()
```


## Exclude highways from the cropped blackout mask
```{r}

```

## Identify homes likely impacted by blackouts
```{r}

```

## Identify the census tracts likely impacted by blackout
```{r}

```


